<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">

<dom-module id="movement-watcher">
  <script>
    class movementWatcher extends ReduxMixin(Polymer.Element) {
      static get is() { return 'movement-watcher'; }
      static get properties() {
        return {
          legs: {
            statePath: 'legs'
          },
          directionJoystick: {
            statePath: 'movement.directionJoystick'
          },
          circles: {
            statePath: 'movement.circles'
          },
          turn: {
            statePath: 'movement.turn'
          }
        }
      }
      
      // calc pointers whenever directionJoystick || this.circles || this.turn changes
      static get observers() {
        return [ 'calcMovementPointers(directionJoystick, circles, turn)' ];
      }
      
      calcMovementPointers() {
        if (this.circles === undefined || this.directionJoystick === undefined || this.turn === undefined) return;

        let pointers = {};
        
        for (let legId = 1; legId <= 6; legId++) {
          pointers[legId] = {};
          
          switch (this.legs[legId].side) {
            case 'left':
              pointers[legId].x = this.circles[legId].x - this.circles[legId].radius * (this.directionJoystick.x / 100); break;
            case 'right':
              pointers[legId].x = this.circles[legId].x + this.circles[legId].radius * (this.directionJoystick.x / 100); break;
          }
          pointers[legId].y = this.circles[legId].y - this.circles[legId].radius * (this.directionJoystick.y / 100);
          
          // apply movement.turn values
          if (this.turn.x)
            this.applyTurn(pointers, this.circles, this.turn, legId, this.legs[legId].side);
        }
        
        this.batchDispatch(pointers);
      }
      
      applyTurn(pointers, circles, turn, legId, side) {
        let dx = pointers[legId].x - circles[legId].x,
            dy = pointers[legId].y - circles[legId].y,
            distance = MU.getDistance(dx, dy),
            currentAngle = MU.getAngle(dy, dx);

        let cx = circles[legId].x,
            cy = circles[legId].y;
            
        switch (side) {
          case 'left':
            pointers[legId] = MU.getCoordsFromDistanceAndAngle(cx, cy, currentAngle - turn.x, distance); break;
          case 'right':
            pointers[legId] = MU.getCoordsFromDistanceAndAngle(cx, cy, currentAngle + turn.x, distance); break;
        }
      }
      
      batchDispatch(payload) {
        store.dispatch({
          type: "MOVEMENT_POINTERS_CHANGED_BATCHED",
          payload
        });      
      }

    }
    window.customElements.define(movementWatcher.is, movementWatcher);
  </script>
</dom-module>