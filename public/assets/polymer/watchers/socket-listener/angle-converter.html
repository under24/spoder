<dom-module id="angle-converter">
  <script>
    class angleConverter extends ReduxMixin(Polymer.Element) {
      static get is() { return 'angle-converter'; }
      static get properties() {
        return {
          coxaAttachmentAngles: {
            statePath: 'base.coxaAttachmentAngles'
          },
          coords: {
            statePath: 'coords'
          },
          metaData: {
            statePath: 'metaData'
          }
        }
      }
      
      processCoordsFromServoAngles(servoAngles) {
        var screenAngles = this.convertServoIntoScreenAngles(servoAngles);
        var coords = this.calcCoordsFromScreenAngles(screenAngles);
        
        return coords;
      }
      
      convertServoIntoScreenAngles(servoAngles) {
        var result = {};
        
        for (let legId = 1; legId < 6; legId++) {
          result[legId] = {
            coxaScreenAngle: GU.correctAngle(servoAngles[legId].coxaServoAngle - 90 + this.coxaAttachmentAngles[legId]),
            femurScreenAngle: GU.correctAngle(servoAngles[legId].femurServoAngle - 90),
            tibiaScreenAngle: servoAngles[legId].tibiaServoAngle
          };
        }
        
        return result;
      }
      
      calcCoordsFromScreenAngles(screenAngles) {
        var result = {};
        
        for (let legId = 1; legId < 6; legId++) {
          // femur
          let sbx = this.coords[legId].sagittalBaseX,
              sby = this.coords[legId].sagittalBaseY,
              femurScreenAngle = screenAngles[legId].femurScreenAngle,
              femurLength = this.metaData.femurLength,
              femurEnd = MU.getCoordsFromDistanceAndAngle(sbx, sby, femurScreenAngle, femurLength);
          // tibia
          let tibiaScreenAngle = screenAngles[legId].tibiaScreenAngle,
              tibiaLength = this.metaData.tibiaLength,
              tibiaEnd = MU.getCoordsFromDistanceAndAngle(femurEnd.x, femurEnd.y, tibiaScreenAngle + femurScreenAngle, tibiaLength);
          // coxa
          let tbx = this.coords[legId].transverseBaseX,
              tby = this.coords[legId].transverseBaseY,
              coxaScreenAngle = screenAngles[legId].coxaScreenAngle,
              coxaLength = tibiaEnd.x - sbx,
              coxaEnd = MU.getCoordsFromDistanceAndAngle(tbx, tby, coxaScreenAngle, coxaLength);
          
          result[legId] = { femurEnd, tibiaEnd, coxaEnd };
        }
        
        return result;
      }

    }
    window.customElements.define(angleConverter.is, angleConverter);
  </script>
</dom-module>