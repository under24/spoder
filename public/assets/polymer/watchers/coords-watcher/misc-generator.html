<dom-module id="misc-generator">
  <script>
    class miscGenerator extends ReduxMixin(Polymer.Element) {
      static get is() { return 'misc-generator'; }
      static get properties() {
        return {
          misc: {
            statePath: 'misc'
          }
        };
      }
      
      processNewMisc(that, legId) {
        // leg in sagittal view is in its range
        var sagittalWithinReach = that.targetWithinReach(legId, 'sagittal');
        
        // sagittal diff x/y
        var dx = that.getDX(legId, 'sagittal'),
            dy = that.getDY(legId, 'sagittal');
            
        // sagittal straight angle from base to cursor
        var angle = MU.getAngle(dy, dx),
            sbx = that.coords[legId].sagittalBaseX,
            sby = that.coords[legId].sagittalBaseY;
            
        // sagittal boundary ball xy
        var sagittalBoundaryBallCoords = MU.getCoordsFromDistanceAndAngle(sbx, sby, angle, that.metaData.combinedLegsLength);
        
        if (!sagittalWithinReach)
          var transverseReachCoords = this.getTransverseReachCoords(that.coords[legId], that.metaData, sagittalBoundaryBallCoords.y);
        else
          var transverseReachCoords = this.getTransverseReachCoords(that.coords[legId], that.metaData);

        return {
          sagittalDiff: { dx, dy },
          // sagittal distance from sagittal cursor x/y to sagittal base x/y
          sagittalDistance: MU.getDistance(dx, dy),
          sagittalAngle: angle,
          sagittalBoundaryBallCoords,
          transverseReachCoords,
          transverseReachRadius: this.getTransverseReachRadius(transverseReachCoords),
          transverseLegLength: this.getTransverseLegLength(sagittalWithinReach, dx, sbx, sagittalBoundaryBallCoords)
        };
      }
      
      getTransverseReachRadius(transverseReachCoords) {
        return transverseReachCoords.endX - transverseReachCoords.beginningX;
      }
      
      getTransverseLegLength(withinReach, dx, sbx, boundaryCoords) {
        if (withinReach) 
          return dx;
        else 
          return boundaryCoords.x - sbx;
      }
      
      getTransverseReachCoords(coords, metaData, customScy) {
        let scy = customScy || coords.sagittalCursorY,
            radius = metaData.combinedLegsLength,
            sbx = coords.sagittalBaseX,
            sby = coords.sagittalBaseY,
            endX = sbx + Math.sqrt(radius * radius - (scy - sby) * (scy - sby));
        
        return {
          endX: endX,
          endY: scy,
          beginningX: coords.sagittalBaseX,
          beginningY: scy,
          possibleX: coords.sagittalBaseX + metaData.impossibleRange,
          possibleY: scy
        }
      }
      
      sieveOutAndGatherUp(legId, misc, payload) {
        // init state. just dispatch misc object without comparing because state object is null
        if (this.misc[legId] === null) {
          payload[legId] = misc;
          return;
        }
        
        // filter in unique values and add them to the payload[legId] object
        GU.sieveOutAndGatherUp(misc, this.misc[legId], payload, legId);
      }
      
      validateAndDispatchMisc(payload) {
        // empty payload object
        if (Object.keys(payload).length === 0) return;
        
        store.dispatch({ type: "MISC_CHANGED_BATCHED", payload });
      }

    }
    window.customElements.define(miscGenerator.is, miscGenerator);
  </script>
</dom-module>