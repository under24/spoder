<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">

<dom-module id="movement-generator">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        position: relative;
      }
      #sequenceTimeline {
        width: 95%;
        border: 1px dotted;
        margin: auto;
        box-sizing: border-box;
        position: relative;
        display: flex;
        flex-direction: column;
      }
      #sequenceTimeline .leg-sequence {
        font-size: 17px;
        display: flex;
        border-top: 1px dotted;
      }
      #sequenceTimeline .leg-sequence:first-child {
        border-top: none;
      }
      #sequenceTimeline .sequence-header {
        display: inline-block;
        border-right: 1px dotted;
        padding: 4px 0px 4px 8px;
        width: 48px;
        font-size: 16px;
      }
      #sequenceTimeline #cursor {
        width: 1px;
        background: black;
        position: absolute;
        display: inline-block;
        top: 0px;
        bottom: 0px;
      }
      #cursorKnob {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(128, 128, 128, 0.2);
        padding: 4px 8px 2px;
      }
      .sequence-content {
        flex: 1;
        position: relative;
      }
      .sequence-content .payload {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.1);
        top: 0px;
        bottom: 0px;
        text-align: center;
        line-height: 26px;
      }
      .cursor-wrapper {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 57px;
        right: 0px;
      }
      fieldset {
        width: 95%;
        box-sizing: border-box;
        margin: 0px auto 10px auto;
        border-width: 1px;
      }
    </style> 

    <br /><br /><br />
    
    <div id="sequenceTimeline">
      <!-- <div class="leg-sequence" id="leg1">
        <div class="sequence-header">Base</div>
        <div class="sequence-content">
          <div class="payload">25</div>
          <div class="payload">25</div>
          <div class="payload">25</div>
          <div class="payload">25</div>
        </div>
      </div>
      <hr /> -->
      <div class="leg-sequence" id="leg1">
        <div class="sequence-header">L1 (1)</div>
        <div class="sequence-content">
          <div class="payload" style$="[[computeStrokeTiming('1', iteration.gait)]]">[[computeCursorMovementData('1', predictedIterationMovementData)]]</div>
        </div>
      </div>
      <div class="leg-sequence" id="leg2">
        <div class="sequence-header">R1 (2)</div>
        <div class="sequence-content">
          <div class="payload" style$="[[computeStrokeTiming('2', iteration.gait)]]">[[computeCursorMovementData('2', predictedIterationMovementData)]]</div>
        </div>
      </div>
      <div class="leg-sequence" id="leg3">
        <div class="sequence-header">L2 (3)</div>
        <div class="sequence-content">
          <div class="payload" style$="[[computeStrokeTiming('3', iteration.gait)]]">[[computeCursorMovementData('3', predictedIterationMovementData)]]</div>
        </div>
      </div>
      <div class="leg-sequence" id="leg4">
        <div class="sequence-header">R2 (4)</div>
        <div class="sequence-content">
          <div class="payload" style$="[[computeStrokeTiming('4', iteration.gait)]]">[[computeCursorMovementData('4', predictedIterationMovementData)]]</div>
        </div>
      </div>
      <div class="leg-sequence" id="leg5">
        <div class="sequence-header">L3 (5)</div>
        <div class="sequence-content">
          <div class="payload" style$="[[computeStrokeTiming('5', iteration.gait)]]">[[computeCursorMovementData('5', predictedIterationMovementData)]]</div>
        </div>
      </div>
      <div class="leg-sequence" id="leg6">
        <div class="sequence-header">R3 (6)</div>
        <div class="sequence-content">
          <div class="payload" style$="[[computeStrokeTiming('6', iteration.gait)]]">[[computeCursorMovementData('6', predictedIterationMovementData)]]</div>
        </div>
      </div>
      
      <div class="cursor-wrapper">
        <div id="cursor" style$="left: [[iteration.currentTickPct]]%">
          <div id="cursorKnob">[[iteration.currentTickPct]]</div>
        </div>
      </div>

    </div>
    
    <br /><br />
    
    <fieldset>
      <legend>Movement settings:</legend>
      <p>
        <label>
          <input type="checkbox" checked={{loop::click}} />
          Loop generator
        </label>
      </p>
      <p>TPS: [[iteration.tps]]</p>
      <p>Iteration Duration: [[iteration.duration]]</p>
    </fieldset>

  </template>

  <script>
    class movementGenerator extends ReduxMixin(Polymer.Element) {
      static get is() { return 'movement-generator'; }
      static get properties() {
        return {
          // baseCenterCoords: {
          //   statePath: 'base.centerCoords'
          // },
          circles: {
            statePath: 'movement.circles'
          },
          coords: {
            statePath: 'coords'
          },
          // directionJoystick: {
          //   statePath: 'movement.directionJoystick'
          // },
          // turnJoystick: {
          //   statePath: 'movement.turnJoystick'
          // },
          gaits: {
            statePath: 'gaits'
          },
          // sequenceProgress: {
          //   statePath: 'movement.sequenceProgress'
          // },
          iteration: {
            statePath: 'movement.iteration'
          },
          loop: {
            statePath: 'movement.settings.loop'
          },
          predictedIterationMovementData: {
            
          },
          pointers: {
            statePath: 'movement.pointers'
          }
        };
      }
      
      static get observers() {
        return [ 'getNextTickValues(pointers)' ];
      }
      
      getNextTickValues() {
        let amountOfTicks = this.iteration.amountOfTicks,
            // full iteration movement data
            predictedIterationMovementData = this.getIterationMovementData(),
            // iteration next tick values (step values)
            stepValues = this.getIterationStepValues(amountOfTicks, predictedIterationMovementData);
            
        debugger;
        
        // performance: ui after calculations
        this.predictedIterationMovementData = predictedIterationMovementData;
      }
      
      getIterationMovementData() {
        let result = {};
        
        for (let legId = 1; legId <= 6; legId++) {
          result[legId] = {};
          
          // transverseBaseXY
          result[legId].transverseBaseX = this.circles[legId].x - this.pointers[legId].x,
          result[legId].transverseBaseY = this.circles[legId].y - this.pointers[legId].y;
          
          // transverseCursorXY
          result[legId].transverseCursorX = this.coords[legId].transverseCursorX - this.pointers[legId].x,
          result[legId].transverseCursorY = this.coords[legId].transverseCursorY - this.pointers[legId].y;
        }
        return result;
      }
      
      getIterationStepValues(amountOfTicks, predictedIterationMovementData) {
        let result = {};
        
        // tick movement data (step value)
        for (let legId = 1; legId <= 6; legId++) {
          result[legId] = {};
          
          let baseStroke = { startPct: 0, endPct: 100 };
          // base
          result[legId].transverseBaseX = this.getTickValue(amountOfTicks, predictedIterationMovementData[legId].transverseBaseX, baseStroke);
          result[legId].transverseBaseY = this.getTickValue(amountOfTicks, predictedIterationMovementData[legId].transverseBaseY, baseStroke);
          
          // cache stroke data
          let stroke = this.gaits[this.iteration.gait].strokes[legId];
          // cursor
          result[legId].transverseCursorX = this.getTickValue(amountOfTicks, predictedIterationMovementData[legId].transverseCursorX, stroke);
          result[legId].transverseCursorY = this.getTickValue(amountOfTicks, predictedIterationMovementData[legId].transverseCursorY, stroke);
        }
        return result;
      }
      
      getTickValue(amountOfTicks, pixelsToMove, stroke) {
        let startTick = this.getClosestTick(stroke.startPct, amountOfTicks) + 1, // because it starts from the next tick
            endTick = this.getClosestTick(stroke.endPct, amountOfTicks),
            ticksBetweenStartAndEnd = this.getAmountOfTicksBetween(startTick, endTick),
            tickValue = this.getTickValueBasedOnPxlsToMove(ticksBetweenStartAndEnd, pixelsToMove);
            
        return tickValue;
      }
      
      getAmountOfTicksBetween(startTick, endTick) {
        return (endTick - startTick) + 1;
      }
      
      getTickValueBasedOnPxlsToMove(amountOfTicks, pixelsToMove) {
        return pixelsToMove / amountOfTicks;
      }
      
      getTickPct(tick, amountOfTicks) {
        return MU.roundNumber(100 / amountOfTicks * tick, 1);
      }
      
      getClosestTick(pct, amountOfTicks) {
        let currentNumber = 0;
        
        let diff = pct;
        for (let tick = 1; tick <= amountOfTicks; tick++) {
          let tickPct = this.getTickPct(tick, amountOfTicks);
          
          let newDiff = Math.abs(pct - tickPct);
          if (newDiff < diff) {
            diff = newDiff;
            currentNumber = tick;
          }
        }
        return +currentNumber;
      }
      
      // UI
      
      computeCursorMovementData(legId, predictedIterationMovementData) {
        let cursorX = predictedIterationMovementData[legId].transverseCursorX,
            cursorY = predictedIterationMovementData[legId].transverseCursorY,
            dist = MU.getDistance(cursorX, cursorY).toFixed(2);
        
        return dist;
      }
      
      computeStrokeTiming(legId, iterationGait) {
        let stroke = this.gaits[iterationGait].strokes[legId];
        
        return `left: ${stroke.startPct}%; width: ${stroke.endPct - stroke.startPct}%;`;
      }

    }
    window.customElements.define(movementGenerator.is, movementGenerator);
  </script>
</dom-module>