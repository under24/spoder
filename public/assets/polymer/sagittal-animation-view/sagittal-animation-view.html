<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">

<dom-module id="sagittal-animation-view">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        position: relative;
      }
      .centerPoint {
        display: inline-block;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0px;
        height: 0px
      }
      .centerPoint::after {
        content: '';
        display: inline-block;
        border-radius: 100%;
        width: 10px;
        height: 10px;
        background-color: black;
        position: absolute;
        transform: translate(-50%, -50%);
      }
      .base {
        height: 20px;
        width: 20px;
        display: inline-block;
        background-color: rgba(0, 0, 255, 0.25);
        position: absolute;
        border-radius: 100%;
      }
      .cursor {
        height: 20px;
        width: 20px;
        display: inline-block;
        background-color: rgba(255, 0, 0, 0.35);
        position: absolute;
        border-radius: 100%;
        transform: translate(-50%,-50%);
      }
      #spoder {
        position: absolute;
        height: 100%;
        width: 100%;
      }
      .femur{
        width: 100px;
        transform-origin: left;
        left: 50%;
        top: 50%;
        position: absolute;
        height: 1px;
        background-color: black;
        z-index: 1;
        pointer-events: none;
      }
      .tibia {
        width: 140px;
        transform-origin: left;
        left: 100%;
        top: 0px;
        position: absolute;
        height: 1px;
        background-color: black;
        z-index: 1;
        pointer-events: none;
      }
      .femur.right {
        transform-origin: right;
        left: initial;
        right: 50%;
      }
      .right .tibia {
        left: initial;
        right: 100%;
        transform-origin: right;
      }
      .floor {
        display: inline-block;
        border-top: 1px dashed rgba(255, 0, 0, 0.5);
        position: absolute;
        top: 0px;
        width: 800px;
        transform: translateX(-50%);
      }
    </style>
    
    <div id="spoder">
      <div class="centerPoint">
        <div class="base leg1" style$="[[computeCoords(coords, angles, '1')]]">
          <div class="femur right" style$="[[computeFemur(angles, '1')]]">
            <div class="tibia" style$="[[computeTibia(angles, '1')]]"></div>
          </div>
        </div>
        <div class="base leg2" style$="[[computeCoords(coords, angles, '2')]]">
          <div class="femur left" style$="[[computeFemur(angles, '2')]]">
            <div class="tibia" style$="[[computeTibia(angles, '2')]]"></div>
          </div>
        </div>
        <div class="base leg3" style$="[[computeCoords(coords, angles, '3')]]">
          <div class="femur right" style$="[[computeFemur(angles, '3')]]">
            <div class="tibia" style$="[[computeTibia(angles, '3')]]"></div>
          </div>
        </div>
        <div class="base leg4" style$="[[computeCoords(coords, angles, '4')]]">
          <div class="femur left" style$="[[computeFemur(angles, '4')]]">
            <div class="tibia" style$="[[computeTibia(angles, '4')]]"></div>
          </div>
        </div>
        <div class="base leg5" style$="[[computeCoords(coords, angles, '5')]]">
          <div class="femur right" style$="[[computeFemur(angles, '5')]]">
            <div class="tibia" style$="[[computeTibia(angles, '5')]]"></div>
          </div>
        </div>
        <div class="base leg6" style$="[[computeCoords(coords, angles, '6')]]">
          <div class="femur left" style$="[[computeFemur(angles, '6')]]">
            <div class="tibia" style$="[[computeTibia(angles, '6')]]"></div>
          </div>
        </div>
        
        <div class="cursor leg1" style$="[[computeCursor(coords, '1')]]"></div>
        <div class="cursor leg2" style$="[[computeCursor(coords, '2')]]"></div>
        <div class="cursor leg3" style$="[[computeCursor(coords, '3')]]"></div>
        <div class="cursor leg4" style$="[[computeCursor(coords, '4')]]"></div>
        <div class="cursor leg5" style$="[[computeCursor(coords, '5')]]"></div>
        <div class="cursor leg6" style$="[[computeCursor(coords, '6')]]"></div>
        
        <div class="floor"></div>
      </div>
    </div>
  </template>

  <script>
    class sagittalAnimationView extends ReduxMixin(Polymer.Element) {
      static get is() { return 'sagittal-animation-view'; }
      static get properties() {
        return {
          baseCoxaAttachmentAngle: {
            statePath: 'base.coxaAttachmentAngle'
          },
          coords: {
            statePath: 'coords'
          },
          angles: {
            statePath: 'angles'
          },
          scale: {
            type: Number,
            value: 0.6,
            observer: 'observeScale'
          }
        };
      }
      
      computeCoords(coords, angles, legId) {
        if (coords === undefined || angles === undefined || this.baseCoxaAttachmentAngle === undefined) return;
        
        let side;
        if (coords[legId].side == 'left') side = 'right';
        if (coords[legId].side == 'right') side = 'left';
        
        let x = side + ': ' + coords[legId].transverseBaseX + 'px;';
        let y = 'top: ' + coords[legId].sagittalBaseY + 'px;';
        
        // let angle = this.baseCoxaAttachmentAngle[legId];
        // let temp = 135 - angles[legId].coxaServoAngle;
        // 
        // let z = 'transform: rotateY(' + temp + 'deg);';
        
        let a;
        switch (coords[legId].legId) {
          case 1:
            a = (180 - angles[legId].coxaServoAngle) + this.baseCoxaAttachmentAngle[legId];
            break;
          case 2:
            a = 180 - angles[legId].coxaServoAngle - this.baseCoxaAttachmentAngle[legId];
            break;
          case 3:
            a = 180 - angles[legId].coxaServoAngle - 90;
            break;
          case 4:
            a = 180 - angles[legId].coxaServoAngle - 90;
            break;
          case 5:
            a = this.baseCoxaAttachmentAngle[legId] - angles[legId].coxaServoAngle;
            break;
          case 6:
            a = Math.abs(this.baseCoxaAttachmentAngle[legId]) - angles[legId].coxaServoAngle;
            break;
        }
        
        a = `transform: rotateY(${a}deg) translate(-50%,-50%);`
        
        return x + y + a;
      }
      
      computeCursor(coords, legId) {
        let side;
        if (coords[legId].side == 'left') side = 'right';
        if (coords[legId].side == 'right') side = 'left';
         
        let x = side + ': ' + coords[legId].transverseCursorX + 'px;';
        let y = 'top: ' + coords[legId].sagittalCursorY + 'px;';
        
        return x + y;
      }
      
      computeFemur(angles, legId) {
        let a = angles[legId].femurScreenAngle;
        if (angles[legId].side == 'left') {
          a = a * -1;
        }
        
        let angle = 'transform: rotate(' + a + 'deg);';
        return angle;
      }
      
      computeTibia(angles, legId) {
        let a = angles[legId].tibiaScreenAngle;
        if (angles[legId].side == 'left') {
          a = a * -1;
        }
        let angle = `transform: rotate(${a}deg);`;
        return angle;
      }
      
      observeScale(scale) {
        this.$.spoder.style.transform = `scale(${scale})`;
      }

    }
    window.customElements.define(sagittalAnimationView.is, sagittalAnimationView);
  </script>
</dom-module>